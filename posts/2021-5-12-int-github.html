<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Continuous integration for data science with pytest, Github Actions, and Hypervector | Hypervector Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.7fad836b.css" as="style"><link rel="preload" href="/assets/js/app.6dd730dd.js" as="script"><link rel="preload" href="/assets/js/2.2b3936c2.js" as="script"><link rel="preload" href="/assets/js/11.2805b7f5.js" as="script"><link rel="prefetch" href="/assets/js/10.0dc516e9.js"><link rel="prefetch" href="/assets/js/3.34628cd6.js"><link rel="prefetch" href="/assets/js/4.edd6654d.js"><link rel="prefetch" href="/assets/js/5.07cf1267.js"><link rel="prefetch" href="/assets/js/6.c6c6814f.js"><link rel="prefetch" href="/assets/js/7.1765a9de.js"><link rel="prefetch" href="/assets/js/8.72a1f351.js"><link rel="prefetch" href="/assets/js/9.1e5d90a8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7fad836b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Hypervector Blog</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="https://hypervector.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Hypervector
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="https://hypervector.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Hypervector
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="continuous-integration-for-data-science-with-pytest-github-actions-and-hypervector"><a href="#continuous-integration-for-data-science-with-pytest-github-actions-and-hypervector" class="header-anchor">#</a> Continuous integration for data science with pytest, Github Actions, and Hypervector</h1> <h4 id="june-10-2021"><a href="#june-10-2021" class="header-anchor">#</a> June 10, 2021</h4> <p style="text-align:center;"><img src="/blog/gears.png" width="100%"></p> <p>Building a continuous integration (CI) step for your production-facing data science models and functions can ensure they remain valid and fit for purpose in a busy codebase. Furthermore, a build test that asserts successfully for all contributors to see helps keep developer confidence high around such components — which can often become 'black box' parts of the stack that only a small number of data scientists have expertise with.</p> <p>This guide outlines how you can build an automated check for a data science feature that runs every time a pull request is opened against the project, using the Python library <a href="https://docs.pytest.org/" target="_blank" rel="noopener noreferrer"><code>pytest</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, Github's continuous integration platform <a href="https://github.com/features/actions" target="_blank" rel="noopener noreferrer">Actions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and <a href="https://hypervector.io" target="_blank" rel="noopener noreferrer">Hypervector<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> — an API for building data science test fixtures easily.</p> <p>Hypervector offers free access as part of its early adopters Alpha programme — you can learn more <a href="https://hypervector.io/alpha" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. All code associated with this tutorial is available <a href="https://github.com/hypervectorio/ci-for-data-science-tutorial" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="a-simple-data-feature"><a href="#a-simple-data-feature" class="header-anchor">#</a> A simple data feature</h2> <p>For this example, we'll build a toy model using data from <code>sklearn</code>'s <code>make_classifier</code>. In reality, your data science or machine learning model is likely to be more complex than the one illustrated — the main aim of this tutorial is to demonstrate the pipeline building process. All code for this data science feature is available <a href="https://github.com/hypervectorio/ci-for-data-science-tutorial/blob/main/Building%20an%20example%20data%20science%20feature.ipynb" target="_blank" rel="noopener noreferrer">in a Jupyter Notebook<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>All dependencies are listed in a <code>requirements.txt</code> in the root directory — simply run <code>pip install -r requirements.txt</code> from your Python 3.8+ environment of choice to install all the necessary libraries - including Hypervector's <a href="https://pypi.org/project/hypervector-wrapper/" target="_blank" rel="noopener noreferrer"><code>hypervector-wrapper</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> helper package.</p> <p>Let's generate a 5,000 example dataset with 4 <code>float</code> dimensions and 2 classes <code>[0, 1]</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> make_classification

X<span class="token punctuation">,</span> y <span class="token operator">=</span> make_classification<span class="token punctuation">(</span>
    n_samples<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">,</span> 
    n_features<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> 
    n_informative<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
    random_state<span class="token operator">=</span><span class="token number">0</span>
<span class="token punctuation">)</span>
</code></pre></div><p>Now we have our data, we can build a very rudimentary classifier using an <code>sklearn</code> <code>Pipeline</code> consisting of a scaling pre-processing step <code>StandardScaler</code> and a <code>RandomForestClassifier</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword">import</span> RandomForestClassifier
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>pipeline <span class="token keyword">import</span> Pipeline
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> StandardScaler
<span class="token keyword">from</span> joblib <span class="token keyword">import</span> dump

X_train<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

pipeline <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">'scaler'</span><span class="token punctuation">,</span> StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'rf'</span><span class="token punctuation">,</span> RandomForestClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

pipeline<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>

dump<span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> <span class="token string">'pipeline.joblib'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> accuracy_score
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> accuracy_score<span class="token punctuation">(</span>y_test<span class="token punctuation">,</span> pipeline<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">0.976</span>
</code></pre></div><p>To take this toy model to a production-like context, we'll 'deploy' it using Flask. This makes it available to provide predictions via a REST endpoint: a fairly common pattern when shipping machine learning components.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> joblib <span class="token keyword">import</span> load

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
model <span class="token operator">=</span> load<span class="token punctuation">(</span><span class="token string">'./pipeline.joblib'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_prediction</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    results <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;prediction&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">]</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> response


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">health_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    feature_vector <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> get_prediction<span class="token punctuation">(</span>feature_vector<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/&lt;a&gt;/&lt;b&gt;/&lt;c&gt;/&lt;d&gt;'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">entrypoint</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">:</span>
    feature_vector <span class="token operator">=</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">]</span>
    <span class="token keyword">return</span> get_prediction<span class="token punctuation">(</span>feature_vector<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Running <code>python app.py</code> from the root of the project will start a local webserver which provides predictions from this model over HTTP. While this is up, you can navigate to <code>localhost:5000</code> to see the model output with inputs <code>[0, 0, 0, 0]</code> (as served by the <code>health_check</code> method), and custom inputs by editing the URL. For example, to get a prediction for the vector <code>[1, 4, 2.5, 0.1]</code>, you would navigate to <code>localhost:5000/1/4/2.5/0.1</code>.</p> <h2 id="writing-a-test-fixture"><a href="#writing-a-test-fixture" class="header-anchor">#</a> Writing a test fixture</h2> <p>With a basic but functional web service providing access to our model, we want to write some tests to ensure the expected output is maintained as development on the project continues. Historically, this might have been done manually by data scientists when re-training a model, but Hypervector allows us to assert this on any change to the codebase — even changes not directly associated with the model artefact itself e.g. when updating library dependencies, when refactoring wrapper functions around the model, when changes occur to upstream data processing.</p> <p>On top of the training data we used to build the classifier, Hypervector allows us to generate up to 10,000 further examples per fixture. This is useful as we can target specific areas of the feature vector distribution for testing, and Hypervector makes this available conveniently via a dedicated endpoint — so there's no headache of managing test resources in version control.</p> <p>Examining the histogram of each of the features across the training data, we'll get an idea of the distribution each of these occupies. This allows us to decide the best statistical properties for a test fixture to run as part of our continuous integration.</p> <p style="text-align:center;"><img src="/blog/features.png" width="75%"></p> <p>For this integration test, we'll generate test fixture data that is broadly equivalent to the training data: a Gaussian distribution <i>N</i>(0, 2) for both feature <code>a</code> and <code>d</code>, and two Gaussian mixtures of <i>N</i>(-0.75, 0.5) + <i>N</i>(0.75, 0.5) and <i>N</i>(-1, 0.5) + <i>N</i>(1, 0.5) for features <code>b</code> and <code>c</code> respectively.</p> <p>This can be defined in Hypervector using a Python dictionary as follows:</p> <div class="language-python extra-class"><pre class="language-python"><code>definition_json <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;definition_name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Classifier test fixture&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;features&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;float&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;distribution&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;gaussian&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mu&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;sigma&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;float&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;distribution&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;mixture&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;components&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span><span class="token string">&quot;mu&quot;</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token string">&quot;sigma&quot;</span><span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token string">&quot;weight&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span><span class="token string">&quot;mu&quot;</span><span class="token punctuation">:</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token string">&quot;sigma&quot;</span><span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token string">&quot;weight&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;float&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;distribution&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;mixture&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;components&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span><span class="token string">&quot;mu&quot;</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;sigma&quot;</span><span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token string">&quot;weight&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span><span class="token string">&quot;mu&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;sigma&quot;</span><span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token string">&quot;weight&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;float&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;distribution&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;gaussian&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mu&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;sigma&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> hypervector
hypervector<span class="token punctuation">.</span>API_KEY <span class="token operator">=</span> <span class="token string">&quot;YOUR_API_KEY&quot;</span>

project <span class="token operator">=</span> hypervector<span class="token punctuation">.</span>Project<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token punctuation">)</span>

definition <span class="token operator">=</span> hypervector<span class="token punctuation">.</span>Definition<span class="token punctuation">.</span>new<span class="token punctuation">(</span>
    definition<span class="token operator">=</span>definition_json<span class="token punctuation">,</span>
    project_uuid<span class="token operator">=</span>project<span class="token punctuation">.</span>project_uuid
<span class="token punctuation">)</span>
</code></pre></div><p>Hypervector generates test fixture data in groups known as Ensembles — we can generate a new Ensemble from this Definition and retrieve the data as follows:</p> <div class="language-python extra-class"><pre class="language-python"><code>ensemble <span class="token operator">=</span> hypervector<span class="token punctuation">.</span>Ensemble<span class="token punctuation">.</span>new<span class="token punctuation">(</span>
    definition_uuid<span class="token operator">=</span>definition<span class="token punctuation">.</span>definition_uuid<span class="token punctuation">,</span>
    size<span class="token operator">=</span><span class="token number">10000</span>
<span class="token punctuation">)</span>
test_fixture_data <span class="token operator">=</span> ensemble<span class="token punctuation">.</span>hypervectors<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>We can look at what's returned to <code>ensemble.hypervectors()</code> from the API for the test fixtures.</p> <p style="text-align:center;"><img src="/blog/fixtures.png" width="75%"></p> <p>The data from this fixture allows us to snapshot the behaviour of <code>pipeline</code> using Hypervector's <code>Benchmark</code> functionality. This saves a hashed representation of the model output which allows for test assertions to be run as part of the CI process.</p> <div class="language-python extra-class"><pre class="language-python"><code>benchmark <span class="token operator">=</span> hypervector<span class="token punctuation">.</span>Benchmark<span class="token punctuation">.</span>new<span class="token punctuation">(</span>
    ensemble<span class="token operator">=</span>ensemble<span class="token punctuation">,</span>
    expected_output<span class="token operator">=</span>pipeline<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_fixture_data<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>To test out that this works as expected, we can assert the same input as the Benchmark was created with to verify the resource exists:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> benchmark<span class="token punctuation">.</span>assert_equal<span class="token punctuation">(</span>pipeline<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_fixture_data<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'assertion_uuid'</span><span class="token punctuation">:</span> <span class="token string">'71f990e9-e336-4207-b146-870f72093d1b'</span><span class="token punctuation">,</span>
 <span class="token string">'timestamp'</span><span class="token punctuation">:</span> <span class="token string">'2021/06/08 13:06:42'</span><span class="token punctuation">,</span>
 <span class="token string">'benchmark_uuid'</span><span class="token punctuation">:</span> <span class="token string">'fce8ef24-fc2f-4d0d-819b-209289a02734'</span><span class="token punctuation">,</span>
 <span class="token string">'ensemble_uuid'</span><span class="token punctuation">:</span> <span class="token string">'e6ed88c0-6fb0-4b6a-bad3-90adfc0e3d17'</span><span class="token punctuation">,</span>
 <span class="token string">'asserted'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
 <span class="token string">'diff'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span>
</code></pre></div><p>We can run this as part of the test suite for the project using <code>pytest</code>, ensuring this is asserted as part of the wider set of tests.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># test_app.py</span>

<span class="token keyword">import</span> hypervector
<span class="token keyword">import</span> pytest

<span class="token keyword">from</span> app <span class="token keyword">import</span> get_prediction

hypervector<span class="token punctuation">.</span>API_KEY <span class="token operator">=</span> <span class="token string">&quot;YOUR_API_KEY&quot;</span>


<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
<span class="token keyword">def</span> <span class="token function">hypervector_fixture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    definition <span class="token operator">=</span> hypervector<span class="token punctuation">.</span>Definition<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;YOUR_DEFINITION_UUID&quot;</span><span class="token punctuation">)</span>
    ensemble <span class="token operator">=</span> definition<span class="token punctuation">.</span>ensembles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    hypervectors <span class="token operator">=</span> ensemble<span class="token punctuation">.</span>hypervectors<span class="token punctuation">(</span><span class="token punctuation">)</span>
    benchmark <span class="token operator">=</span> ensemble<span class="token punctuation">.</span>benchmarks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> hypervectors<span class="token punctuation">,</span> benchmark


<span class="token keyword">def</span> <span class="token function">test_single_prediction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    test_case <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    result <span class="token operator">=</span> get_prediction<span class="token punctuation">(</span>test_case<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'prediction'</span><span class="token punctuation">]</span>
    <span class="token keyword">assert</span> result <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">test_bulk_prediction</span><span class="token punctuation">(</span>hypervector_fixture<span class="token punctuation">)</span><span class="token punctuation">:</span>
    hypervectors<span class="token punctuation">,</span> benchmark <span class="token operator">=</span> hypervector_fixture
    results <span class="token operator">=</span> get_prediction<span class="token punctuation">(</span>hypervectors<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'prediction'</span><span class="token punctuation">]</span>
    assertion <span class="token operator">=</span> benchmark<span class="token punctuation">.</span>assert_equal<span class="token punctuation">(</span>results<span class="token punctuation">)</span>

    <span class="token keyword">assert</span> assertion<span class="token punctuation">[</span><span class="token string">'asserted'</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token boolean">True</span>
</code></pre></div><p>You can see there's two tests for our model — <code>test_single_prediction()</code> which ensures a single input feature vector of <code>[0, 0, 0, 0]</code> returns the class <code>1</code> as expected, and <code>test_bulk_prediction()</code> which uses our Hypervector Ensemble and Benchmark.</p> <p>Running <code>pytest</code> from the root of the project will assert against these tests.</p> <p style="text-align:center;"><img src="/blog/pytest.png" width="100%"></p> <h2 id="automating-the-test-pipeline"><a href="#automating-the-test-pipeline" class="header-anchor">#</a> Automating the test pipeline</h2> <p>Using Github Actions in conjunction with our Hypervector fixture, we'll automate the test suite to run as part of the continuous integration strategy for this codebase.  Hypervector provides an <a href="https://github.com/hypervectorio/hypervector-results-gh-action" target="_blank" rel="noopener noreferrer">Action specifically for reporting the results of the last assertion<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and you can make use of this by adding the a <code>.github/workflows/main.yaml</code> file to the project with the following:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> Run Hypervector tests

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> main <span class="token punctuation">]</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
      <span class="token key atrule">matrix</span><span class="token punctuation">:</span>
        <span class="token key atrule">python-version</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3.8</span><span class="token punctuation">]</span>

    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Python $<span class="token punctuation">{</span><span class="token punctuation">{</span> matrix.python<span class="token punctuation">-</span>version <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>python@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">python-version</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> matrix.python<span class="token punctuation">-</span>version <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install dependencies
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          python -m pip install --upgrade pip
          pip install -r requirements.txt</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run tests
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          pytest</span>
        <span class="token key atrule">continue-on-error</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get Hypervector results
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> hypervectorio/hypervector<span class="token punctuation">-</span>results<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>action@1.0.0
        <span class="token key atrule">id</span><span class="token punctuation">:</span> hypervector
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITHUB_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">hypervector_api_key</span><span class="token punctuation">:</span> YOUR_API_KEY
</code></pre></div><p>Opening a pull request against a new branch of a project will automatically return the results of the last Hypervector assertion to the pull request's conversation — making it easy to verify there's been no breaking changes. The pull request used in this example is available <a href="https://github.com/hypervectorio/ci-for-data-science-tutorial/pull/1" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p style="text-align:center;"><img src="/blog/passing.png" width="80%"></p> <p>Let's deliberately introduce a regression to see what a failure case looks like. If we introduce another preprocessing step to the <code>get_prediction()</code> method in our service, erroneous predictions will be brought back by the model. We'll use <code>MinMaxScaler()</code> for this breaking change:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_prediction</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># adding breaking change</span>
    scaler <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
    scaler<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    data <span class="token operator">=</span> scaler<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    results <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;prediction&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">]</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> response
</code></pre></div><p>Pushing this to the open pull request on the branch above will result in a <code>test_bulk_prediction()</code> failure, and a Hypervector diff is auto-commented on the pull request.</p> <p style="text-align:center;"><img src="/blog/failing.png" width="80%"></p> <p>Most importantly, we can see the test has failed as expected. Breaking this example down further, Hypervector provides the size of the ensemble (<code>size: 10000</code>), the number of failing cases (<code>n_failures: 5650</code>), and the indices and inputs of the first 10 failing cases (diffs can get large with Ensemble size, so the <code>truncated</code> option filters the first N values for convenience).</p> <p>Furthermore, we can click through on the provided Assertion history deep-link to have a closer look at what's going on in the Hypervector Dashboard:</p> <p style="text-align:center;"><img src="/blog/benchmark-history.png" width="90%"></p> <p>Hypervector tracks each Assertion against every Benchmark, and you can retrieve the full diff including all failing cases from here for further analysis of any code- or model-based regressions that might have been introduced.</p> <p>In this case, the failing Assertion across so many cases of this Benchmark would probably be enough to signal that a service-side breaking change had been introduced (which was the case), and that the PR should not be merged into the project.</p> <h2 id="hypervector-s-alpha-beyond"><a href="#hypervector-s-alpha-beyond" class="header-anchor">#</a> Hypervector's Alpha &amp; beyond</h2> <p>Now there's a test fixture in place to verify your data science feature is still fit for purpose, you can begin contributing to the codebase with more confidence and speed without the worry of introducing tricky regressions and silent breaking changes to your data science features.</p> <p>Hypervector is an API for bringing improved quality to data-driven software. <a href="https://hypervector.io/alpha" target="_blank" rel="noopener noreferrer">It's currently in Alpha<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> at the moment, which allows you to build a single Project with a Definition, Ensemble and Benchmark for free. Happy testing!</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6dd730dd.js" defer></script><script src="/assets/js/2.2b3936c2.js" defer></script><script src="/assets/js/11.2805b7f5.js" defer></script>
  </body>
</html>
